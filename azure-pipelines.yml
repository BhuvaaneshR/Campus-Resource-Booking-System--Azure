trigger:
  branches:
    include:
      - main

variables:
  acrName: 'campusbookingacr'
  resourceGroup: 'campusbookingrg'
  backendApp: 'campus-booking-backend-api'
  frontendApp: 'campus-booking-frontend-web'
  backendUrl: 'https://campus-booking-backend-api.azurewebsites.net'

stages:
  # BUILD STAGE
  - stage: Build
    displayName: 'Build and Push Images'
    jobs:
      - job: BuildBackend
        displayName: 'Build Backend'
        pool:
          vmImage: 'ubuntu-latest'
        steps:
          - script: |
              cd backend
              echo "Building backend..."
            displayName: 'Navigate to Backend'
          
          - task: Docker@2
            displayName: 'Build Backend Image'
            inputs:
              containerRegistry: 'campusbookingacr-connection'
              repository: 'backend'
              command: 'build'
              Dockerfile: 'backend/Dockerfile'
              tags: '$(Build.BuildId)'
          
          - task: Docker@2
            displayName: 'Push Backend Image'
            inputs:
              containerRegistry: 'campusbookingacr-connection'
              repository: 'backend'
              command: 'push'
              tags: '$(Build.BuildId)'

      - job: BuildFrontend
        displayName: 'Build Frontend'
        pool:
          vmImage: 'ubuntu-latest'
        steps:
          - script: |
              cd frontend
              echo "REACT_APP_API_URL=$(backendUrl)" > .env.production
              cat .env.production
            displayName: 'Create Frontend .env.production'
          
          - task: Docker@2
            displayName: 'Build Frontend Image'
            inputs:
              containerRegistry: 'campusbookingacr-connection'
              repository: 'frontend'
              command: 'build'
              Dockerfile: 'frontend/Dockerfile'
              tags: '$(Build.BuildId)'
          
          - task: Docker@2
            displayName: 'Push Frontend Image'
            inputs:
              containerRegistry: 'campusbookingacr-connection'
              repository: 'frontend'
              command: 'push'
              tags: '$(Build.BuildId)'

  # DEPLOY STAGE - COMMENTED OUT FOR TESTING
  # - stage: Deploy
  #   displayName: 'Deploy to Azure'
  #   dependsOn: Build
  #   jobs:
  #     - deployment: DeployBackend